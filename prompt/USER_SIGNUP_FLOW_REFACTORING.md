# 사용자 회원가입 플로우 리팩토링 계획

## 현재 문제점
- 회원가입 시 Database Trigger로 자동 명함/비즈니스 카드 생성
- 사용자가 명함 내용을 입력하지 않았는데 빈 명함이 생성됨
- 신규회원과 기존회원 구분이 불가능
- 온보딩 중단 시 재진입 플로우가 명확하지 않음

## 개선된 플로우

### 1. 신규 회원 가입 플로우
```
회원가입 → 이메일 인증 → 온보딩 페이지 → 명함 생성하기 → 명함 내용 입력 → 명함 생성 완료
```

### 2. 기존 회원 로그인 플로우
```
로그인 → 명함 존재 여부 확인
├── 명함 있음: 일반 홈 화면
└── 명함 없음: 온보딩 페이지 → 명함 생성 진행
```

## 온보딩 페이지 구조

### 서비스 소개 슬라이드 (5페이지)
1. **페이지 1**: "Neimed에 오신 것을 환영합니다!"
   - 서비스 개요 및 환영 메시지
   - [다음] 버튼

2. **페이지 2**: "디지털 명함으로 네트워킹하세요"
   - 디지털 명함의 장점과 기능 설명
   - [이전] [다음] 버튼

3. **페이지 3**: "이벤트에서 쉽게 명함을 교환하세요"
   - QR코드 스캔, 이벤트 참여 기능 설명
   - [이전] [다음] 버튼

4. **페이지 4**: "수집한 명함을 관리하세요"
   - 명함 수집, 정리, 검색 기능 설명
   - [이전] [다음] 버튼

5. **페이지 5**: "이제 나만의 명함을 만들어보세요!"
   - 명함 생성 안내 및 동기부여
   - **[명함 생성하기]** 버튼 (핵심!)

## 구현 작업 목록

### 1. Database Trigger 제거
- [x] `handle_new_user()` 함수에서 business_cards 자동 생성 로직 제거
- [x] user_profiles만 생성하도록 수정
- [x] 기존 빈 business_cards 데이터 정리

### 2. 인증 완료 후 리다이렉트 수정
- [x] `app/(auth)/verify/page.tsx`에서 `/client/onboarding`으로 이동 확인
- [x] 첫 회원가입임을 명확히 표시

### 3. 온보딩 페이지 개선
- [x] `components/user/user-onboarding-client.tsx` 5단계 슬라이드 구조로 개선
- [x] 각 페이지별 서비스 소개 콘텐츠 작성
- [x] 마지막 페이지에 "명함 생성하기" 버튼 추가
- [x] 버튼 클릭 시 `/client/namecard/create`로 이동

### 4. 명함 생성 플로우 수정
- [x] `app/client/namecard/create/page.tsx`에서 실제 명함 내용 입력 폼 (이미 구현됨)
- [x] 필수 정보: 이름, 회사, 연락처, 소개글 등
- [x] 생성 완료 시에만 business_cards 테이블에 INSERT
- [x] 생성 완료 후 `/client/home`으로 이동

### 5. 로그인 시 명함 존재 여부 체크
- [x] `components/user/simple-user-layout.tsx`에서 business_cards 존재 여부 확인
- [x] 명함 없으면 `/client/onboarding`으로 리다이렉트
- [x] 명함 있으면 정상 플로우 진행
- [x] **확인 방식**: `business_cards` 테이블에서 `user_id`로 데이터 존재 여부 체크

### 6. 기존 회원 처리
- [x] 이미 빈 명함이 있는 기존 회원들 대상 데이터 정리 완료
- [x] 실제 내용이 있는 명함과 빈 명함 구분 로직 (빈 company, introduction 삭제)

## 🎉 구현 완료! (2025-09-21)

### ✅ 구현된 새로운 플로우

**신규 회원 가입:**
```
회원가입 → 이메일 인증 → 온보딩 (5단계) → 명함 생성하기 버튼 → 명함 내용 입력 → 홈
```

**기존 회원 로그인:**
```
로그인 → 명함 존재 확인 (business_cards 테이블)
├── 명함 있음: 홈으로 이동
└── 명함 없음: 온보딩으로 리다이렉트
```

### 🔍 명함 존재 확인 방식
**위치**: `components/user/simple-user-layout.tsx:65-79`

```typescript
// business_cards 테이블에서 user_id로 데이터 존재 여부 확인
const { data: businessCard } = await supabase
  .from('business_cards')
  .select('id')
  .eq('user_id', session.user.id)
  .single()

// 명함이 없으면 온보딩으로 리다이렉트
if (!businessCard) {
  router.push('/client/onboarding')
}
```

### 📊 기대 효과 (달성됨)
- [x] 신규/기존 회원 명확한 구분 가능
- [x] 사용자가 실제로 원할 때만 명함 생성
- [x] 온보딩 중단 후 재진입 가능
- [x] 더 나은 사용자 경험 제공
- [x] 명함 생성 의도가 명확한 사용자만 필터링

### ⚠️ 주의사항 (처리됨)
- [x] 기존 사용자들의 명함 데이터 손실 방지 (빈 데이터만 정리)
- [ ] 온보딩 건너뛰기 옵션 고려 (추후)
- [ ] 명함 생성 중단 시 임시 저장 기능 고려 (추후)