# 🚀 사용자/관리자 완전 분리 체크리스트

## 📋 프로젝트 개요
- **목표**: 한 도메인에서 `/user`, `/admin` 경로로 완전 분리
- **핵심**: 같은 이메일로 사용자/관리자 각각 가입 가능
- **기술**: 별도 Supabase 프로젝트 + 경로 기반 클라이언트 분기

---

## 🎯 Phase 1: 현재 상태 분석 및 준비

### ✅ 현재 Supabase 프로젝트 분석
- [x] 기존 프로젝트 ID: `kyibcvcwwvkldlasxyjn` 확인
- [x] 현재 테이블 구조 분석 완료
- [ ] 기존 사용자 데이터 백업
- [ ] 역할별 데이터 분류 (user vs admin)

### ✅ 새 관리자 Supabase 프로젝트 생성
- [x] 새 Supabase 프로젝트 생성
- [x] 프로젝트 이름: `ndrop-admin-app`
- [x] 리전: `ap-northeast-1` (기존과 동일)
- [x] 프로젝트 URL 및 키 확보

## 🔍 현재 데이터베이스 현황 분석 (2025-09-21)

### 📊 사용자 DB (kyibcvcwwvkldlasxyjn) - 8개 테이블
**핵심 사용자 테이블:**
- `user_profiles` (1 row) - 사용자 프로필 정보, role_id 포함
- `business_cards` (1 row) - 명함 정보
- `collected_cards` (0 rows) - 수집한 명함들
- `feedback` (0 rows) - 사용자 피드백

**이벤트 관련 테이블:**
- `events` (0 rows) - 이벤트 정보 (관리자가 생성)
- `event_participants` (0 rows) - 이벤트 참여자

**시스템 테이블:**
- `roles` (2 rows) - user, admin 역할 정의
- `notifications` (0 rows) - 알림
- `notifications_backup` (0 rows) - 알림 백업

### 📊 관리자 DB (amkgtndbzpqisdodbxhw) - 0개 테이블
**상태**: 빈 데이터베이스 (설정 필요)

### 🚨 중요 발견사항
1. **role_id 시스템 존재**: user_profiles에 role_id가 있어 관리자/사용자 구분 중
2. **명함 자동 생성 문제**: business_cards에 1개 데이터 (빈 명함 추정)
3. **관리자 DB 미설정**: 완전히 비어있음
4. **혼재된 구조**: 사용자 DB에 이벤트 테이블까지 모두 존재

---

## 🗄️ Phase 2: 데이터베이스 설계 및 마이그레이션

### ✅ 관리자 DB 스키마 생성
- [ ] `admin_profiles` 테이블 생성
- [ ] `events` 테이블 생성 (관리자가 생성/관리)
- [ ] `event_analytics` 테이블 생성
- [ ] `admin_notifications` 테이블 생성
- [ ] `system_settings` 테이블 생성
- [ ] `user_summary` 테이블 생성 (사용자 요약 정보)
- [ ] `participation_summary` 테이블 생성

### ✅ 사용자 DB 정리
- [ ] 기존 `user_profiles`에서 관리자 데이터 제거
- [ ] `role_id` 시스템 제거 (더 이상 불필요)
- [ ] `roles` 테이블 제거 (더 이상 불필요)
- [ ] `events` 테이블을 읽기 전용으로 변경
- [ ] 사용자 전용 테이블만 유지
- [ ] **즉시 해결**: Database Trigger에서 business_cards 자동 생성 제거

### ✅ RLS (Row Level Security) 정책 설정
- [ ] 관리자 DB: 관리자만 접근 가능하도록 설정
- [ ] 사용자 DB: 사용자만 접근 가능하도록 설정
- [ ] 교차 접근 차단 정책 적용

---

## 💻 Phase 3: 코드 구조 변경

### ✅ 폴더 구조 재정비
- [ ] `app/user/` 디렉토리 생성
- [ ] `app/admin/` 디렉토리 정리
- [ ] 기존 `app/(client)/` 내용을 `app/user/`로 이동
- [ ] 공통 로그인 페이지 `app/(auth)/` 정리
- [ ] API 라우트 `app/api/user/`, `app/api/admin/` 분리

### ✅ Supabase 클라이언트 분리
- [ ] `utils/supabase/user-client.ts` 생성
- [ ] `utils/supabase/admin-client.ts` 생성
- [ ] 기존 `utils/supabase/client.ts` 동적 분기 로직 구현
- [ ] 환경 변수 설정 (USER, ADMIN 별도)

### ✅ Auth Store 완전 분리
- [ ] `stores/auth-store.ts` 제거 (통합 스토어 불필요)
- [ ] `stores/user-auth-store.ts` 사용자 클라이언트 사용하도록 수정
- [ ] `stores/admin-auth-store.ts` 관리자 클라이언트 사용하도록 수정
- [ ] 각 스토어에서 적절한 데이터베이스만 접근

---

## 🛣️ Phase 4: 라우팅 및 레이아웃 설정

### ✅ Next.js 라우팅 구조
- [ ] `app/user/layout.tsx` - 사용자 레이아웃 + 인증 가드
- [ ] `app/admin/layout.tsx` - 관리자 레이아웃 + 인증 가드
- [ ] `middleware.ts` - 경로별 접근 제어
- [ ] 리다이렉트 규칙 설정

### ✅ 인증 가드 구현
- [ ] 사용자 페이지: `useUserAuthStore` 인증 체크
- [ ] 관리자 페이지: `useAdminAuthStore` 인증 체크
- [ ] 미인증 시 적절한 로그인 페이지로 리다이렉트

---

## 🔄 Phase 5: 데이터 동기화 시스템

### ✅ 이벤트 데이터 동기화
- [ ] 관리자가 이벤트 생성 시 사용자 DB로 복사
- [ ] 이벤트 수정 시 자동 동기화
- [ ] 이벤트 삭제 시 양쪽 DB에서 모두 처리
- [ ] 실시간 동기화 로직 구현

### ✅ 참여자 데이터 동기화
- [ ] 사용자 이벤트 참여 시 관리자 DB로 요약 정보 전송
- [ ] 참여자 수 실시간 업데이트
- [ ] 참여자 목록 관리자에서 조회 가능

### ✅ API 엔드포인트 구현
- [ ] `/api/sync/events` - 이벤트 동기화
- [ ] `/api/sync/participants` - 참여자 동기화
- [ ] `/api/admin/user-summary` - 사용자 요약 정보 제공

---

## 🔧 Phase 6: 기능별 상세 구현

### ✅ 사용자 기능 (/user/*)
- [ ] `/user/home` - 사용자 홈 (이벤트 목록 등)
- [ ] `/user/profile` - 프로필 관리
- [ ] `/user/business-card` - 명함 생성/관리
- [ ] `/user/events` - 이벤트 참여 관리
- [ ] `/user/my-page` - 마이페이지

### ✅ 관리자 기능 (/admin/*)
- [ ] `/admin/dashboard` - 관리자 대시보드
- [ ] `/admin/events` - 이벤트 관리
- [ ] `/admin/events/new` - 새 이벤트 생성
- [ ] `/admin/events/[id]/participants` - 참여자 관리
- [ ] `/admin/members` - 사용자 관리
- [ ] `/admin/notifications` - 알림 관리
- [ ] `/admin/feedback` - 피드백 관리

### ✅ 공통 기능
- [ ] 로그인 페이지 분기 처리
- [ ] 회원가입 페이지 분기 처리
- [ ] 비밀번호 재설정 분기 처리
- [ ] OAuth 로그인 분기 처리

---

## 🧪 Phase 7: 테스트 및 검증

### ✅ 사용자 기능 테스트
- [ ] 사용자 회원가입/로그인 테스트
- [ ] 프로필 생성/수정 테스트
- [ ] 명함 생성/수정/공유 테스트
- [ ] 이벤트 참여/취소 테스트
- [ ] QR 코드 생성/스캔 테스트

### ✅ 관리자 기능 테스트
- [ ] 관리자 회원가입/로그인 테스트
- [ ] 이벤트 생성/수정/삭제 테스트
- [ ] 참여자 관리 테스트
- [ ] 알림 발송 테스트
- [ ] 대시보드 통계 테스트

### ✅ 동기화 테스트
- [ ] 이벤트 생성 시 사용자 DB 동기화 확인
- [ ] 참여자 등록 시 관리자 DB 업데이트 확인
- [ ] 실시간 데이터 정합성 검증
- [ ] 동기화 실패 시 재시도 로직 테스트

### ✅ 보안 테스트
- [ ] 사용자가 관리자 페이지 접근 차단 확인
- [ ] 관리자가 사용자 DB 직접 접근 차단 확인
- [ ] 교차 인증 시도 차단 확인
- [ ] SQL 인젝션 방어 테스트

---

## 🚀 Phase 8: 배포 및 운영

### ✅ 환경 설정
- [ ] Production 환경 변수 설정
- [ ] Supabase 프로덕션 키 적용
- [ ] DNS 설정 (단일 도메인)
- [ ] HTTPS 인증서 설정

### ✅ 배포 검증
- [ ] 사용자 경로 `/user/*` 접근 테스트
- [ ] 관리자 경로 `/admin/*` 접근 테스트
- [ ] 로그인 플로우 전체 테스트
- [ ] 모바일 반응형 테스트
- [ ] 성능 테스트

### ✅ 모니터링 설정
- [ ] 에러 추적 설정
- [ ] 로그 모니터링 설정
- [ ] 사용자 행동 분석 설정
- [ ] 알림 시스템 설정

---

## 🔍 Phase 9: 데이터 일관성 검증

### ✅ 데이터 검증
- [ ] 기존 사용자 데이터 손실 없음 확인
- [ ] 이벤트 데이터 정합성 확인
- [ ] 명함 데이터 보존 확인
- [ ] 참여 기록 보존 확인

### ✅ 백업 및 복구
- [ ] 마이그레이션 전 전체 데이터 백업
- [ ] 롤백 계획 수립
- [ ] 복구 테스트 실행
- [ ] 비상 대응 절차 문서화

---

## 📊 성공 기준

### ✅ 기능적 요구사항
- [ ] 같은 이메일로 사용자/관리자 각각 가입 가능
- [ ] 모든 기존 기능이 정상 동작
- [ ] 데이터 손실 없음
- [ ] 사용자 경험 저하 없음

### ✅ 비기능적 요구사항
- [ ] 페이지 로딩 시간 3초 이내
- [ ] 데이터 동기화 지연 10초 이내
- [ ] 99.9% 가용성 유지
- [ ] 보안 취약점 0개

---

## 🎯 마일스톤

- **Week 1**: Phase 1-3 완료 (DB 설계 및 코드 구조 변경)
- **Week 2**: Phase 4-6 완료 (라우팅 및 기능 구현)
- **Week 3**: Phase 7-9 완료 (테스트 및 배포)

---

**⚠️ 중요 참고사항**
- 모든 변경사항은 feature branch에서 작업
- 각 Phase 완료 후 코드 리뷰 필수
- 데이터 마이그레이션 전 반드시 백업
- 사용자 영향 최소화를 위한 점진적 배포

---

## 🎯 우선순위 작업 (2025-09-21 현재)

### 🔥 즉시 해결 필요
1. **Database Trigger 수정** - business_cards 자동 생성 제거
2. **회원가입 플로우 수정** - 온보딩 → 명시적 명함 생성으로 변경
3. **기존 빈 명함 데이터 정리** - 의미 있는 데이터만 유지

### 📋 단계별 진행
1. **Week 1**: 회원가입 플로우 개선 (USER_SIGNUP_FLOW_REFACTORING.md 참조)
2. **Week 2**: 관리자 DB 스키마 설계 및 구축
3. **Week 3**: 완전 분리 시스템 구현 및 테스트

### 🔄 연관 문서
- `USER_SIGNUP_FLOW_REFACTORING.md` - 회원가입 플로우 개선 계획
- 현재 체크리스트 - 전체 사용자/관리자 분리 계획

---

**📅 체크리스트 생성일**: 2025-09-20
**📝 최종 업데이트**: 2025-09-21 (DB 현황 분석 추가)
**👨‍💻 담당자**: Claude AI + 개발팀
**🗃️ 현재 상태**: Phase 1 부분 완료, 우선순위 작업 식별됨
